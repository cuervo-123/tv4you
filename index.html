<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mi TV Station - Listados y Favoritos</title>
  <style>
    body {
      background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
      color: #e0e0e0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      display: flex;
    }
    aside {
      width: 250px;
      background-color: #1c1c1c;
      padding: 20px;
      border-right: 2px solid #00ffd5;
      height: 100vh;
      box-sizing: border-box;
    }
    main {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      color: #00ffd5;
      margin-bottom: 20px;
      text-shadow: 0 0 10px #00ffd5;
    }
    #channel-select, #buscador, #fileInput {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #00ffd5;
      background: #222;
      color: #00ffd5;
      margin-bottom: 20px;
      width: 100%;
      max-width: 700px;
    }
    button {
      padding: 10px 20px;
      background: #00ffd5;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background: #00c4a7;
    }
    .menu-item {
      margin: 10px 0;
      color: #00ffd5;
      cursor: pointer;
    }
    .menu-item:hover {
      text-decoration: underline;
    }
    #favoritos-list {
      display: none;
      background: #2a2a2a;
      padding: 15px;
      border-radius: 12px;
      margin-top: 20px;
      width: 100%;
      max-width: 700px;
    }
    .favorito-item {
      padding: 5px;
      margin-bottom: 5px;
      background: #3a3a3a;
      border-radius: 6px;
      cursor: pointer;
    }
    .favorito-item:hover {
      background: #505050;
    }
  </style>
</head>
<body>
  <aside>
    <h2>üìÅ Men√∫</h2>
    <div class="menu-item" onclick="mostrarSeccion('canales')">Canales</div>
    <div class="menu-item" onclick="mostrarSeccion('favoritos')">Favoritos</div>
    <div class="menu-item">Categor√≠as</div>
    <div class="menu-item">Internos</div>
  </aside>
  <main>
    <h1>Mi TV Station</h1>

    <input type="file" id="fileInput" accept=".m3u,.json" onchange="handleFileUpload(event)" />
    <input type="text" id="buscador" placeholder="üîç Buscar canal..." oninput="filtrarCanales()" />

    <select id="channel-select" onchange="playSelectedChannel()">
      <option value="">Cargando canales...</option>
    </select>

    <button onclick="agregarAFavoritos()">‚≠ê Agregar a Favoritos</button>

    <div id="favoritos-list"></div>

    <video id="videoPlayer"
           controls
           autoplay
           muted
           playsinline
           style="width:100%; max-width:700px; background:#000; border-radius:12px; border:2px solid #00ffd5;"
           poster="https://via.placeholder.com/640x360?text=Cargando+video">
      Tu navegador no soporta la reproducci√≥n de video en vivo.
    </video>
  </main>

  <script>
    let channelsData = [];
    let favoritos = JSON.parse(localStorage.getItem('favoritos') || '[]');

    function playChannel(url) {
      const video = document.getElementById('videoPlayer');
      if (window.hls) {
        window.hls.destroy();
        window.hls = null;
      }
      video.src = url;
      video.load();
      video.play();
    }

    function playSelectedChannel() {
      const select = document.getElementById('channel-select');
      const url = select.value;
      if (url) playChannel(url);
    }

    function parseM3U(content) {
      const lines = content.split('\n');
      const channels = [];
      let currentTitle = '';
      lines.forEach((line, index) => {
        line = line.trim();
        if (line.startsWith('#EXTINF')) {
          const titleMatch = line.match(/,(.*)$/);
          currentTitle = titleMatch ? titleMatch[1].trim() : `Canal ${index}`;
        } else if (line && !line.startsWith('#')) {
          channels.push({ title: currentTitle, url: line });
          currentTitle = '';
        }
      });
      return channels;
    }

    function parseJSON(content) {
      try {
        const data = JSON.parse(content);
        return Array.isArray(data) ? data : [];
      } catch (e) {
        alert('‚ùå Archivo JSON inv√°lido');
        return [];
      }
    }

    function cargarCanales(channels) {
      const select = document.getElementById('channel-select');
      select.innerHTML = '';
      channels.forEach((channel, index) => {
        const option = document.createElement('option');
        option.value = channel.url;
        option.textContent = channel.title;
        select.appendChild(option);
      });
      if (channels.length > 0) {
        select.selectedIndex = 0;
        playChannel(channels[0].url);
      }
    }

    function filtrarCanales() {
      const input = document.getElementById('buscador').value.toLowerCase();
      const select = document.getElementById('channel-select');
      select.innerHTML = '';
      channelsData.forEach(channel => {
        if (channel.title.toLowerCase().includes(input)) {
          const option = document.createElement('option');
          option.value = channel.url;
          option.textContent = channel.title;
          select.appendChild(option);
        }
      });
    }

    function agregarAFavoritos() {
      const select = document.getElementById('channel-select');
      const index = select.selectedIndex;
      if (index >= 0) {
        const canal = channelsData[index];
        if (!favoritos.find(f => f.url === canal.url)) {
          favoritos.push(canal);
          localStorage.setItem('favoritos', JSON.stringify(favoritos));
          alert('‚úÖ Canal agregado a favoritos');
        } else {
          alert('‚ö†Ô∏è Ya est√° en favoritos');
        }
      }
    }

    function mostrarFavoritos() {
      const contenedor = document.getElementById('favoritos-list');
      contenedor.innerHTML = '<h3>‚≠ê Favoritos:</h3>';
      favoritos.forEach(fav => {
        const div = document.createElement('div');
        div.className = 'favorito-item';
        div.textContent = fav.title;
        div.onclick = () => playChannel(fav.url);
        contenedor.appendChild(div);
      });
      contenedor.style.display = 'block';
    }

    function mostrarSeccion(seccion) {
      const favoritosList = document.getElementById('favoritos-list');
      if (seccion === 'favoritos') {
        mostrarFavoritos();
      } else {
        favoritosList.style.display = 'none';
      }
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const content = e.target.result;
        if (file.name.endsWith('.m3u')) {
          channelsData = parseM3U(content);
        } else if (file.name.endsWith('.json')) {
          channelsData = parseJSON(content);
        }
        cargarCanales(channelsData);
      };
      reader.readAsText(file);
    }

    window.addEventListener('DOMContentLoaded', () => {
      fetch("https://cuervo-123.github.io/mi-tv-station/update3.m3u")
        .then(res => res.text())
        .then(data => {
          console.log("‚úÖ Contenido m3u:", data.slice(0, 300));
          const canales = parseM3U(data);
          console.log("‚úÖ Canales parseados:", canales);
          if (canales.length === 0) {
            alert("‚ö†Ô∏è No se encontraron canales en update3.m3u");
          }
          channelsData = canales;
          cargarCanales(channelsData);
        })
        .catch(err => {
          console.error("‚ùå Error al cargar update3.m3u:", err);
        });
    });
  </script>
</body>
</html>
