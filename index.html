<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>THE APP TV GLOBAL STATION</title>

  <style>
    :root{
      --bg:#eeeeee;
      --panel:#222;
      --card:#333;
      --card2:#2b2b2b;
      --text:#fff;
      --accent:#00ffd5;
      --star:#f6d04d;
      --muted:#c9c9c9;
    }

    .flecha-carrusel {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 2rem;
      color: white;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      z-index: 10;
      display:grid;
      place-items:center;
    }
    .flecha-izquierda { left: 5px; }
    .flecha-derecha { right: 5px; }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    header, main, footer { padding: 1rem; }

    h1{ color:#111; margin:0 0 .75rem; }
    header h1:first-child{ color:#111; }

    select{
      width:100%;
      padding:.55rem;
      border-radius:8px;
      margin:.35rem 0 .75rem;
      border:1px solid #ddd;
    }

    /* Barra de acciones */
    .actions{
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
      margin-top:.5rem;
      align-items:center;
    }
    .btn{
      background:#111;
      color:#fff;
      border:none;
      border-radius:10px;
      padding:.55rem .85rem;
      cursor:pointer;
      font-weight:700;
    }
    .btn:hover{ opacity:.9; }
    .btn.outline{
      background:transparent;
      color:#111;
      border:2px solid #111;
    }

    #buscador {
      width: 100%;
      padding: 0.5rem;
      margin: .5rem 0 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      color:#111;
    }

    /* Carruseles */
    .row-title{
      color:#111;
      font-weight:800;
      margin:.25rem 0 .5rem;
    }

    #favoritos-wrapper, #carrusel-wrapper { position: relative; }

    .strip {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--panel);
      scroll-behavior: smooth;
      border-radius:12px;
    }

    .canal {
      background: var(--card);
      border-radius: 12px;
      padding: 0.55rem 0.75rem;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 0.55rem;
      user-select:none;
      border:2px solid transparent;
      min-width: 220px;
      position: relative;
    }
    .canal:hover { background: #555; }

    .canal img {
      width: 42px;
      height: 42px;
      border-radius: 8px;
      object-fit: contain;
      background: #000;
    }

    .canal .name{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .canal .name strong{
      font-size:.95rem;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 140px;
    }
    .canal .name small{
      font-size:.75rem;
      color: var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 140px;
    }

    /* Estrella favoritos */
    .fav-btn{
      position:absolute;
      top:8px;
      right:8px;
      width:32px;
      height:32px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(0,0,0,.35);
      display:grid;
      place-items:center;
      cursor:pointer;
      z-index:2;
    }
    .fav-btn:hover{ background: rgba(0,0,0,.55); }

    .fav-btn span{
      font-size: 18px;
      line-height:1;
      color:#bbb;
      transform: translateY(-1px);
    }
    .canal.fav{ border-color: rgba(246,208,77,.75); }
    .canal.fav .fav-btn span{ color: var(--star); text-shadow: 0 0 10px rgba(246,208,77,.35); }

    #videoPlayer {
      width: 100%;
      max-width: 900px;
      height: 50vh;
      background: #000;
      border: 2px solid var(--accent);
      border-radius: 12px;
      margin: 0 auto 1rem;
      display: block;
    }

    /* Flechas para carrusel fav (m√°s peque√±as) */
    .flecha-sm{
      width:42px;height:42px;font-size:1.6rem;
    }

    /* Mensaje vac√≠o */
    .empty{
      color:#ddd;
      background:#2b2b2b;
      padding:.75rem 1rem;
      border-radius:10px;
    }
  </style>
</head>

<body>
  <header>
    <h1>üì∫ THE APP TV GLOBAL STATION</h1>

    <select id="selectorPais">
      <option value="https://cuervo-123.github.io/tv4you/paises/listado canales en espanol .m3u">listado canales en espanol</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/lg.m3u">lg</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/lista de Colombia m3u.m3u">lista de Colombia</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/latam.m3u">latam</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/ssungusa.m3u">ssung usa</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/global.m3u">Global</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/colombia.m3u">üá®üá¥ Colombia</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/brazil.m3u">Brazil</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/bolivia.m3u"> Bolivia</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/ecuador.m3u">Ecuador</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/bosnia.herzegovina.m3u">Bosnia.Herzegovina</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Bulgaria.m3u">Bulgaria</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Czech Republic.m3u">Czech Republic</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Country  France.m3u">France</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Democratic Republic of the Congo.m3u">Democratic Republic of the Congo</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Dominican Republic.m3u">Dominican Republic</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Country  Cameroon.m3u">Cameroon</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Country  Finland.m3u">Finland</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Country Ethiopia.m3u">Ethiopia</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Country  Estonia.m3u">Estonia</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Country  Egypt.m3u">Egypt</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/localnow.m3u">localnow</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/xiaomi.m3u">xiaomi</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/xumo.m3u">xumo</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/favoritos premium -2.json">premium</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Country Curacao.m3u">Curacao</option>
    </select>

    <h1>üì∫ CATEGORIES</h1>
    <select id="selectorPais2">
      <option value="https://cuervo-123.github.io/tv4you/paises/LISTADO DE CAMARAS IP.m3u">Camaras Ip Generales</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Cine.m3u">Cine</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Deportes.m3u">Deportes</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Infantil.m3u">Infantil</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Musica.m3u">Musica</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Noticias.m3u">Noticias</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Series.m3u">Series</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Bulgaria .m3u">Bulgaria</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Czech Republic .m3u">Czech Republic</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Democratic Republic of the Congo .m3u">Democratic Republic of the Congo</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/Dominican Republic.m3u">Dominican Republic</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/musica and favoritos.m3u">musica and favoritos</option>
      <option value="https://cuervo-123.github.io/tv4you/paises/karaoke gladys .m3u">Karaoke Gladys</option>
    </select>

    <input type="text" id="buscador" placeholder="Buscar canal..." />

    <div class="actions">
      <button class="btn" id="btnSoloFav">‚≠ê Ver solo Favoritos</button>
      <button class="btn outline" id="btnVerTodos">üì∫ Ver Todos</button>
      <button class="btn outline" id="btnClearFav">üßπ Borrar Favoritos</button>
    </div>
  </header>

  <main>
    <video id="videoPlayer" controls playsinline></video>

    <!-- Carrusel Favoritos -->
    <div class="row-title">‚≠ê Favoritos</div>
    <div id="favoritos-wrapper" style="position:relative; margin-bottom: 12px;">
      <button class="flecha-carrusel flecha-izquierda flecha-sm" onclick="scrollStrip('favoritos-strip', -1)">‚¨ÖÔ∏è</button>
      <div id="favoritos-strip" class="strip"></div>
      <button class="flecha-carrusel flecha-derecha flecha-sm" onclick="scrollStrip('favoritos-strip', 1)">‚û°Ô∏è</button>
    </div>

    <!-- Carrusel principal -->
    <div class="row-title">üì∫ Canales</div>
    <div id="carrusel-wrapper" style="position: relative;">
      <button class="flecha-carrusel flecha-izquierda" onclick="scrollStrip('canales-inferiores', -1)">‚¨ÖÔ∏è</button>
      <div id="canales-inferiores" class="strip"></div>
      <button class="flecha-carrusel flecha-derecha" onclick="scrollStrip('canales-inferiores', 1)">‚û°Ô∏è</button>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const video = document.getElementById("videoPlayer");
    let listaOriginalCanales = [];
    let hlsInstance = null;

    const FAV_KEY = "APP_GLOBAL_FAVORITOS_V1";

    function normKey(c){
      // clave estable por url (y nombre por si acaso)
      return (c?.url || "").trim();
    }

    function loadFavs(){
      try { return JSON.parse(localStorage.getItem(FAV_KEY) || "[]"); }
      catch { return []; }
    }

    function saveFavs(arr){
      localStorage.setItem(FAV_KEY, JSON.stringify(arr));
    }

    function isFav(canal){
      const favs = loadFavs();
      return favs.some(f => normKey(f) === normKey(canal));
    }

    function toggleFav(canal){
      const favs = loadFavs();
      const key = normKey(canal);
      const idx = favs.findIndex(f => normKey(f) === key);
      if(idx >= 0){
        favs.splice(idx, 1);
      }else{
        favs.push({ nombre: canal.nombre, url: canal.url, logo: canal.logo || "" });
      }
      saveFavs(favs);
      renderFavoritos();
      // re-render lista para pintar estrellas
      mostrarCanales(listaOriginalCanales, false);
    }

    function parseM3U(texto) {
      const lineas = (texto || "").split('\n');
      const canales = [];
      for (let i = 0; i < lineas.length; i++) {
        const linea = (lineas[i] || "").trim();
        if (linea.startsWith('#EXTINF')) {
          const titulo = linea.split(',')[1]?.trim() || 'Canal sin nombre';
          const logoMatch = linea.match(/tvg-logo="(.*?)"/);
          const logo = logoMatch ? logoMatch[1] : "";
          const url = (lineas[i + 1] || "").trim();
          if (url && url.startsWith('http')) {
            canales.push({ nombre: titulo, url, logo });
          }
        }
      }
      return canales;
    }

    function playCanal(canal){
      if(!canal?.url) return;

      // destruir HLS anterior si existe
      if(hlsInstance){
        try{ hlsInstance.destroy(); }catch(e){}
        hlsInstance = null;
      }

      const url = canal.url;

      if (window.Hls && Hls.isSupported() && /\.m3u8(\?|$)/i.test(url)) {
        hlsInstance = new Hls();
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
      } else if (video.canPlayType && video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', () => video.play().catch(()=>{}), { once:true });
      } else {
        video.src = url;
        video.play().catch(()=>{});
      }
    }

    function canalCard(canal){
      const div = document.createElement("div");
      div.className = "canal";

      if(isFav(canal)) div.classList.add("fav");

      // estrella
      const favBtn = document.createElement("div");
      favBtn.className = "fav-btn";
      favBtn.innerHTML = `<span>${isFav(canal) ? "‚òÖ" : "‚òÜ"}</span>`;
      favBtn.title = isFav(canal) ? "Quitar de favoritos" : "Agregar a favoritos";
      favBtn.onclick = (ev) => {
        ev.stopPropagation();
        toggleFav(canal);
      };
      div.appendChild(favBtn);

      if (canal.logo) {
        const img = document.createElement("img");
        img.src = canal.logo;
        img.alt = canal.nombre;
        img.onerror = () => { img.style.display = "none"; };
        div.appendChild(img);
      }

      const meta = document.createElement("div");
      meta.className = "name";

      const strong = document.createElement("strong");
      strong.textContent = canal.nombre || "Canal";
      meta.appendChild(strong);

      const small = document.createElement("small");
      try{ small.textContent = new URL(canal.url).hostname; }catch{ small.textContent = ""; }
      meta.appendChild(small);

      div.appendChild(meta);

      div.onclick = () => playCanal(canal);

      return div;
    }

    function mostrarCanales(canales, guardarOriginal = false) {
      if (guardarOriginal) listaOriginalCanales = canales;

      const contenedor = document.getElementById("canales-inferiores");
      contenedor.innerHTML = "";

      if(!canales?.length){
        contenedor.innerHTML = `<div class="empty">No se cargaron canales.</div>`;
        return;
      }

      const frag = document.createDocumentFragment();
      canales.forEach((canal) => frag.appendChild(canalCard(canal)));
      contenedor.appendChild(frag);

      // refresca favoritos strip tambi√©n
      renderFavoritos();
    }

    function renderFavoritos(){
      const strip = document.getElementById("favoritos-strip");
      const favs = loadFavs();

      strip.innerHTML = "";
      if(!favs.length){
        strip.innerHTML = `<div class="empty">Todav√≠a no tienes favoritos. Marca ‚≠ê en cualquier canal.</div>`;
        return;
      }

      const frag = document.createDocumentFragment();
      favs.forEach(c => frag.appendChild(canalCard(c)));
      strip.appendChild(frag);
    }

    function cargarLista(url) {
      fetch(url)
        .then(res => res.text())
        .then(data => {
          const canales = parseM3U(data);
          mostrarCanales(canales, true);
        })
        .catch(err => console.error("Error al cargar la lista:", err));
    }

    function scrollStrip(id, direccion) {
      const el = document.getElementById(id);
      if(!el) return;
      const cantidad = 320 * direccion;
      el.scrollBy({ left: cantidad, behavior: "smooth" });
    }

    // buscador
    document.getElementById("buscador").addEventListener("input", function(){
      const q = (this.value || "").toLowerCase().trim();
      if(!q){
        mostrarCanales(listaOriginalCanales, false);
        return;
      }
      const filtrados = listaOriginalCanales.filter(c => (c.nombre||"").toLowerCase().includes(q));
      mostrarCanales(filtrados, false);
    });

    // botones
    document.getElementById("btnSoloFav").addEventListener("click", ()=>{
      const favs = loadFavs();
      if(!favs.length) return alert("No tienes favoritos todav√≠a.");
      mostrarCanales(favs, false);
    });

    document.getElementById("btnVerTodos").addEventListener("click", ()=>{
      mostrarCanales(listaOriginalCanales, false);
    });

    document.getElementById("btnClearFav").addEventListener("click", ()=>{
      if(!confirm("¬øBorrar todos los favoritos?")) return;
      saveFavs([]);
      renderFavoritos();
      mostrarCanales(listaOriginalCanales, false);
    });

    // selectors
    document.getElementById("selectorPais").addEventListener("change", function () {
      cargarLista(this.value);
    });
    document.getElementById("selectorPais2").addEventListener("change", function () {
      cargarLista(this.value);
    });

    // init
    renderFavoritos();

    // ‚ö†Ô∏è tu default original dec√≠a update3.m3u pero aqu√≠ estabas llamando local.
    // Si quieres cargar una URL directa por defecto, pon la URL completa:
    // cargarLista("https://cuervo-123.github.io/tv4you/paises/global.m3u");
    // Por ahora dejo tu llamada tal cual:
    cargarLista("update3.m3u");
  </script>
</body>
</html>
